<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" type="image/x-icon" href="./image/favicon.ico">
    <title>Кошик</title>        
</head>
<body>
<header>
    <nav id="nav" class="topnav">
        <div class="nav-logo"><a href="./index.html">RUBY</a></div>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()"><i class="fa fa-bars"></i></a>
        <div class="nav-main">
            <div class="nav-first">
                <a href="./menu.html">Меню</a>
                <a href="./index.html#about-us">Про нас</a>
                <a href="./news.html">Новини</a>
                <a href="./info.html">Інформація</a>
                <a href="./contacts.html">Контакти</a>
            </div>
            <div class="nav-second">
                <a href="./account.html"><i class="fa fa-user" aria-hidden="true"></i></a>
                <a href="./shoppingcart.html"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
            </div>
        </div>   
    </nav>
</header>

<main>
    <div id="scrollToTopBtn"></div>
    <script src="code.js"></script>       
    <div class="banner">
        <img src="./image/waves_4.png" width="100%" alt="волны">
    </div>
    <div class="main">
        <h2 class="title">Кошик</h2>
        
        <div id="cartMessage" style="text-align: center; display: none; padding: 20px;"></div>

        <div class="shop-cart filters">
            <p class="shop-cart-summ" id="totalPrice">Сума до сплати: 0 грн</p>
            <div class="shop-cart-but">
                <button class="filter-button" onclick="goToOrder()">Замовити обрані</button>
            </div>
        </div>
        
        <div class="menu-cards-container" id="cartContainer">
            <p style="width: 100%; text-align: center;">Завантаження...</p>
        </div>

        <div class="cont">
            <button class="cont-button"><img src="./image/Line 1.png"></button>
        </div>
    </div>
</main>
<div id="footer"></div>

<script>
    let API_CART_URL = '/backend/api/cart.php'; 
    if (window.location.pathname.includes('/frontend/')) { API_CART_URL = '../backend/api/cart.php'; }

    document.addEventListener('DOMContentLoaded', () => {
        loadCart();
    });

    function loadCart() {
        const userDataStr = localStorage.getItem('user_data');
        if (!userDataStr) {
            document.getElementById('cartContainer').innerHTML = '<p style="text-align:center; width:100%">Увійдіть в акаунт, щоб побачити кошик</p>';
            return;
        }
        
        const userEmail = JSON.parse(userDataStr).email;

        fetch(API_CART_URL + '?action=get', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                renderCart(data.items);
                document.getElementById('totalPrice').textContent = `Сума до сплати: ${data.total} грн`;
            } else {
                document.getElementById('cartContainer').innerHTML = `<p style="text-align:center;">${data.message}</p>`;
            }
        })
        .catch(err => console.error(err));
    }

    function renderCart(items) {
        const container = document.getElementById('cartContainer');
        container.innerHTML = ''; 

        if (items.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%">Кошик порожній</p>';
            return;
        }

        items.forEach(item => {
            const imgUrl = item.image_url || './image/image 1.png';
            
            const html = `
            <div class="card-container" id="item-${item.item_id}">
                <div class="shop-cart-img">
                    <img class="card-img" src="${imgUrl}" alt="${item.name}">
                    <!-- Кнопка видалення -->
                    <button onclick="removeItem(${item.item_id})" style="position:absolute; top:10px; right:10px; background:white; border-radius:50%; width:30px; height:30px; border:none; cursor:pointer; color:red; font-weight:bold;">&times;</button>
                </div>
                <div class="card">
                    <div class="card-text">
                        <p class="card-name">${item.name}</p>
                        <p class="card-descr">${item.price} грн за шт.</p>
                    </div>
                    <div class="card-details">
                        <div>
                            <p class="weight">${item.weight || '1 кг'}</p>
                            <p class="card-price">${item.price * item.quantity} грн</p>
                        </div>
                        <div class="card-quantity">
                            <span>${item.quantity} шт.</span>
                        </div>  
                    </div>
                </div>
            </div>
            `;
            container.innerHTML += html;
        });
    }

    function removeItem(itemId) {
        if(!confirm('Видалити цей товар з кошика?')) return;

        fetch(API_CART_URL + '?action=remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId: itemId })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                loadCart(); 
            } else {
                alert(data.message);
            }
        });
    }

        function goToOrder() {
        const userDataStr = localStorage.getItem('user_data');
        if (!userDataStr) {
            alert('Будь ласка, увійдіть в акаунт для оформлення замовлення');
            window.location.href = 'account.html';
            return;
        }

        window.location.href = 'order.html';
    }
</script>
</body>
</html>