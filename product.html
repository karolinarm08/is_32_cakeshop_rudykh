<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" type="image/x-icon" href="./image/favicon.ico">
    <title id="productTitle">*</title>
</head>
<body>
<header>
    <nav id="nav" class="topnav">
        <div class="nav-logo"><a href="./index.html">RUBY</a></div>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()">
            <i class="fa fa-bars"></i>
        </a>
        <div class="nav-main">
            <div class="nav-first">
                <a href="./menu.html" class="active">Меню</a>
                <a href="./index.html#about-us">Про нас</a>
                <a href="./news.html">Новини</a>
                <a href="./info.html">Інформація</a>
                <a href="./contacts.html">Контакти</a>
            </div>
            <div class="nav-second">
                <a href="./account.html"><i class="fa fa-user" aria-hidden="true"></i></a>
                <a href="./shoppingcart.html"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
            </div>
        </div>   
    </nav>
</header>

<main>
    <div id="scrollToTopBtn"></div>
    <script src="code.js"></script>
    
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 1000; display: none; justify-content: center; align-items: center; flex-direction: column; color: #4A148C; font-size: 1.5rem;">
        <i class="fa fa-spinner fa-spin text-4xl mb-4"></i>
        <span>Завантаження...</span>
        <p id="errorDisplay" style="color: red; font-size: 0.8em; margin-top: 10px; display: none; text-align: center; max-width: 90%;"></p>
        <div id="cartMessage" style="color: #4CAF50; font-size: 1em; margin-top: 10px; display: none; text-align: center; max-width: 90%; padding: 10px; border: 1px solid; border-radius: 5px;"></div>
    </div>
    
    <div class="banner">
        <img src="./image/waves_4.png" width="100%" alt="волны">
    </div>
    <div>
        <div class="product-panel-buttons">
            <a href="./menu.html" class="come-back-arrow">
                <img src="./image/Arrow 1.svg" alt="Повернутись">
                <p>повернутись</p>
            </a>
            <div class="change-buttons" id="adminButtons" style="display: none;">
                <button class="change-button" id="btnEdit">Редагувати</button>
                <button class="change-button" id="btnDelete" style="border-color: red; color: red;">Видалити</button>
            </div>
        </div>
        <section class="product">
            <div class="product-images">
                <img id="selectedImage" src="./image/placeholder.png" alt="Selected Cake" onerror="this.src='./image/placeholder.png';">
                
                <div class="thumbnail-row-wrapper">
                    <div class="thumbnail-row" id="thumbnailRow">
                    </div>
                </div>
            </div>
            <div class="product-descr">
                <h1 class="section-title" id="productName">Завантаження...</h1>
                <p class="product-text" id="productDescription">Завантаження опису...</p>
                <select class="product-weight-form" id="productWeightSelect">
                    <option value="">1 кг</option>
                </select>

                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <label for="productQuantityInput" class="product-text" style="margin-bottom: 0;">Кількість:</label>
                    <input type="number" id="productQuantityInput" value="1" min="1" class="product-quantity-input" style="width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 5px;">
                </div>

                <span class="product-price" id="productPrice">0 грн</span>
                
                <button class="product-add" id="addToCartButton">У кошик</button>
            </div>

        </section>
        <section class="product-additional-info">
            <h1 class="section-title">Додаткова інформація</h1>
            <p class="product-text" id="additionalInfoText">
                Завантаження додаткової інформації...
            </p>
        </section>
        <section class="product-recommended">
            <h1 class="section-title">Рекомендовані</h1>
            <div class="cards-container" id="recommendedProducts">
            </div>
        </section>
        <section class="product-reviews">
            <img src="./image/waves_3.png" width="100%" alt="волны">
            <h2 class="section-title">Відгуки</h2>
            <div class="cards-container" id="reviewsContainer">
            </div>
        </section>
    </div>
</main>
<div id="footer"></div>

<script>
    function getProductIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id') || 1;
    }

    function selectImage(imageSrc) {
        document.getElementById('selectedImage').src = imageSrc;
    }

    function createThumbnail(imageSrc, altText) {
        const img = document.createElement('img');
        img.className = 'thumbnail'; 
        img.src = imageSrc;
        img.alt = altText;
        img.onclick = () => selectImage(imageSrc);
        img.onerror = function() { this.src = './image/placeholder.png'; };
        document.getElementById('thumbnailRow').appendChild(img);
    }
    
    function createRecommendedCard(product) {
        const productUrl = `./product.html?id=${product.id}`; 
        const imageSrc = product.main_image || "./image/placeholder.png";
        
        const cardHtml = `
            <a href="${productUrl}" class="card-container">
                <img class="card-img" src="${imageSrc}" 
                    onerror="this.onerror=null;this.src='./image/placeholder.png';" 
                    alt="${product.name}">
                <div class="card">
                    <div class="card-text">
                        <p class="card-name">${product.name || 'Назва'}</p>
                        <p class="card-descr">${product.description || 'Опис'}</p>
                    </div>
                    <div class="card-details">
                        <p class="card-weight">${product.weight || 0} кг</p>
                        <p class="card-price">${product.price || 0} грн</p>
                    </div>
                </div>
            </a>
        `;
        const div = document.createElement('div');
        div.innerHTML = cardHtml.trim();
        document.getElementById('recommendedProducts').appendChild(div.firstChild);
    }

    function showMessage(text, isSuccess) {
        const cartMessageDiv = document.getElementById('cartMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        cartMessageDiv.textContent = text;
        cartMessageDiv.style.color = isSuccess ? '#2e7d32' : '#d32f2f';
        cartMessageDiv.style.borderColor = isSuccess ? '#a5d6a7' : '#ef9a9a';
        cartMessageDiv.style.display = 'block';
        loadingOverlay.style.display = 'flex'; 

        setTimeout(() => {
            cartMessageDiv.style.display = 'none';
            if (document.getElementById('errorDisplay').style.display === 'none') {
                 loadingOverlay.style.display = 'none';
            }
        }, 3000);
    }

    function checkAdminAccess() {
        const userDataStr = localStorage.getItem('user_data');
        if (userDataStr) {
            const user = JSON.parse(userDataStr);
            if (user.role === 'admin') {
                document.getElementById('adminButtons').style.display = 'flex';
                
                const productId = getProductIdFromUrl();
                
                document.getElementById('btnEdit').onclick = () => {
                    window.location.href = `product_change.html?id=${productId}`;
                };
                
                document.getElementById('btnDelete').onclick = () => {
                    if (confirm('Ви впевнені, що хочете видалити цей товар назавжди?')) {
                        deleteProduct(productId);
                    }
                };
            }
        }
    }

    async function deleteProduct(id) {
        let apiPath = '/backend/product_api.php?action=delete';
        if (window.location.pathname.includes('/frontend/')) {
             apiPath = '../backend/product_api.php?action=delete';
        }

        try {
            const response = await fetch(apiPath, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            const data = await response.json();
            
            if (data.success) {
                alert('Товар успішно видалено!');
                window.location.href = 'menu.html';
            } else {
                alert('Помилка: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Помилка з\'єднання з сервером.');
        }
    }

    async function fetchProductDetails(productId) {
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        let apiPath = '/backend/product_api.php?action=get&id=' + productId;
        if (window.location.pathname.includes('/frontend/')) {
             apiPath = '../backend/product_api.php?action=get&id=' + productId;
        }

        try {
            const response = await fetch(apiPath);
            if (!response.ok) throw new Error(`HTTP Status ${response.status}`);
            const data = await response.json();

            if (data.success && data.product) {
                const product = data.product;

                document.getElementById('productTitle').textContent = product.name || 'Продукт';
                document.getElementById('productName').textContent = product.name || 'Назва продукту';
                document.getElementById('productDescription').textContent = product.description || '';
                document.getElementById('productPrice').textContent = `${product.price || 0} грн`;
                
                const mainImage = product.main_image || './image/image 1 5.png';
                document.getElementById('selectedImage').src = mainImage;

                const thumbnailRow = document.getElementById('thumbnailRow');
                thumbnailRow.innerHTML = ''; 
                
                if (product.images_array && Array.isArray(product.images_array) && product.images_array.length > 0) {
                    product.images_array.forEach(img => createThumbnail(img, product.name));
                } else {
                    createThumbnail(mainImage, product.name); 
                }
                
                document.getElementById('productWeightSelect').innerHTML = `<option value="${product.weight}">${product.weight} кг</option>`;
                
                const infoText = `
                    <strong>Склад:</strong> ${product.ingredients || '-'}<br>
                    <strong>Термін придатності:</strong> ${product.storage_time || '-'}<br>
                    <strong>Умови зберігання:</strong> ${product.storage_conditions || '-'}
                `;
                document.getElementById('additionalInfoText').innerHTML = infoText;

                if (data.recommended_products) {
                    data.recommended_products.forEach(p => createRecommendedCard(p));
                }

            } else {
                console.warn(data.message);
            }

        } catch (error) {
            console.error("Помилка:", error);
        }
    }

    async function handleAddToCart() {
        const productId = getProductIdFromUrl();
        const quantityInput = document.getElementById('productQuantityInput');
        let quantity = parseInt(quantityInput.value);
        if (isNaN(quantity) || quantity <= 0) {
            showMessage('Вкажіть кількість > 0.', false);
            return;
        }

        const userDataStr = localStorage.getItem('user_data');
        if (!userDataStr) {
            showMessage('Увійдіть в акаунт, щоб додати товар.', false);
            setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            return;
        }
        
        const userEmail = JSON.parse(userDataStr).email;
        
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('errorDisplay').style.display = 'none';
        document.getElementById('cartMessage').style.display = 'none';

        let apiPath = '/backend/api/cart.php?action=add';
        if (window.location.pathname.includes('/frontend/')) {
             apiPath = '../backend/api/cart.php?action=add';
        }
        
        try {
            const response = await fetch(apiPath, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    productId: parseInt(productId),
                    quantity: quantity
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage(`✅ Товар додано до кошика!`, true);
            } else {
                showMessage(`❌ Помилка: ${data.message}`, false);
            }
        } catch (error) {
            showMessage('Помилка з\'єднання.', false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const productId = getProductIdFromUrl();
        fetchProductDetails(productId);
        checkAdminAccess(); 
        
        const addToCartButton = document.getElementById('addToCartButton');
        if (addToCartButton) {
            addToCartButton.addEventListener('click', handleAddToCart);
        }
    });
</script>
</body>
</html>