<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" type="image/x-icon" href="./image/favicon.ico">
    <title>Оформлення замовлення</title>
</head>

<body>
    <header>
        <nav id="nav" class="topnav">
            <div class="nav-logo"><a href="./index.html">RUBY</a></div>
            <a href="javascript:void(0);" class="icon" onclick="myFunction()">
                <i class="fa fa-bars"></i>
            </a>
            <div class="nav-main">
                <div class="nav-first">
                    <a href="./menu.html">Меню</a>
                    <a href="./index.html#about-us">Про нас</a>
                    <a href="./news.html">Новини</a>
                    <a href="./info.html">Інформація</a>
                    <a href="./contacts.html">Контакти</a>
                </div>
                <div class="nav-second">
                    <a href="./account.html"><i class="fa fa-user" aria-hidden="true"></i></a>
                    <a href="./shoppingcart.html"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div id="scrollToTopBtn"></div>
        <script src="code.js"></script>
        <div class="banner">
            <img src="./image/waves_4.png" width="100%" alt="хвилі">
        </div>
        
        <div class="main order">
            <h2 class="title">Оформлення замовлення</h2>
            
            <div class="order-grid">
                <div class="order-forms">
                    <div class="form-group">
                        <h3>Персональні дані</h3>
                        <div class="account-link">
                            <span>або </span><a href="./account.html">Увійти в кабінет</a>
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label for="lname">Прізвище*</label>
                                <input type="text" id="lname" name="lname" class="account-input" required>
                            </div>
                            <div>
                                <label for="fname">Ім'я*</label>
                                <input type="text" id="fname" name="fname" class="account-input" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div>
                                <label for="phnumber">Контактний телефон*</label>
                                <input type="tel" id="phnumber" name="phnumber" class="account-input" required>
                            </div>
                            <div>
                                <label for="email">Електронна пошта*</label>
                                <input type="email" id="email" name="email" class="account-input" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3>Адреса доставки</h3>
                        <div id="saved-addresses" class="saved-addresses">
                        </div>
                        
                        <div class="form-row">
                            <div class="full-width">
                                <label for="city">Місто*</label>
                                <input type="text" id="city" name="city" class="account-input" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="full-width">
                                <label for="street">Вулиця*</label>
                                <input type="text" id="street" name="street" class="account-input" required>
                            </div>
                        </div>
                        
                        <div class="form-row address-fields">
                            <div>
                                <label for="house">Будинок*</label>
                                <input type="text" id="house" name="house" class="account-input" required>
                            </div>
                            <div>
                                <label for="apartment">Квартира</label>
                                <input type="text" id="apartment" name="apartment" class="account-input">
                            </div>
                            <div>
                                <label for="floor">Поверх</label>
                                <input type="text" id="floor" name="floor" class="account-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3>Спосіб оплати</h3>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="payment" value="card" checked> 
                                <span>Карткою онлайн</span>
                            </label>
                            <label>
                                <input type="radio" name="payment" value="cash"> 
                                <span>Готівкою при отриманні</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3>Коментар до замовлення (необов'язково)</h3>
                        <div class="full-width">
                            <textarea id="comment" name="comment" class="text-area" rows="4" 
                                placeholder="Наприклад: дзвонити після 18:00, залишити біля дверей..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="order-summary">
                    <div class="summary-section">
                        <h3>Ваше замовлення</h3>
                        <div id="cartItemsContainer" class="order-cards">
                            <p>Завантаження товарів...</p>
                        </div>
                    </div>

                    <div class="summary-section">
                        <h3>Підсумок</h3>
                        <div class="price-summary">
                            <div class="price-row">
                                <span>Вартість товарів:</span>
                                <span id="subtotal">0.00 грн</span>
                            </div>
                            <div class="price-row">
                                <span>Доставка:</span>
                                <span id="delivery-price">0.00 грн</span>
                            </div>
                            <div class="price-row total">
                                <span>До сплати:</span>
                                <span id="total-price">0.00 грн</span>
                            </div>
                        </div>
                    </div>

                    <div class="summary-section">
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="consent" name="consent" required>
                                <span class="checkbox-text">Даю згоду на обробку персональних даних*</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="no-call" name="no_call">
                                <span class="checkbox-text">Не дзвонити для підтвердження</span>
                            </label>
                        </div>
                    </div>

                    <div class="summary-section">
                        <button type="button" class="confirm-button" onclick="submitOrder()">
                            Підтвердити замовлення
                        </button>
                        <p id="orderMessage" class="order-message"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div id="footer"></div>

    <style>
        .order-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        @media (min-width: 992px) {
            .order-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .order-forms {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .form-group {
            background: var(--color-white);
            border-radius: var(--card-border);
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--color-grey-light);
        }

        .form-group h3 {
            color: var(--color-purple);
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-row > div {
            flex: 1;
            min-width: 200px;
        }

        .full-width {
            width: 100%;
            flex: 1 0 100%;
        }

        .address-fields > div {
            flex: 1;
            min-width: 120px;
        }

        .account-link {
            margin-bottom: 20px;
            font-size: 14px;
        }

        .account-link a {
            color: var(--color-blue);
            text-decoration: none;
            font-weight: 600;
        }

        .account-link a:hover {
            text-decoration: underline;
        }

        .account-input, .text-area {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--color-grey-light);
            border-radius: var(--button-border);
            font-family: "Montserrat", sans-serif;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .account-input:focus, .text-area:focus {
            outline: none;
            border-color: var(--color-purple);
            box-shadow: 0 0 0 2px rgba(127, 75, 147, 0.1);
        }

        .text-area {
            resize: vertical;
            min-height: 100px;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }

        .radio-group input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .order-summary {
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: sticky;
            top: 100px;
        }

        .summary-section {
            background: var(--color-white);
            border-radius: var(--card-border);
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--color-grey-light);
        }

        .order-cards {
            display: flex;
            flex-direction: row; 
            flex-wrap: nowrap;
            gap: 15px; 
            overflow-x: auto; 
            overflow-y: hidden; 
            padding-bottom: 15px; 
            
            max-height: none; 
            padding-right: 0; 
        }

        .order-cards::-webkit-scrollbar {
            height: 10px; 
            width: 6px; 
        }
        
        .order-cards::-webkit-scrollbar-thumb {
             background-color: var(--color-purple-light);
             border-radius: 100px;
        }
        
        .order-card-small {
            max-width: 250px; 
            flex-shrink: 0; 
            margin-right: 0; 
            
            width: 100%; 
            transition: box-shadow 0.4s ease-in-out;
            background-color: var(--color-background); 
            border: 0; 
        }

        @media (max-width: 992px) {
            .order-card-small {
                max-width: 45%; 
                min-width: 180px; 
                align-self: stretch;
            }
        }
        
        @media (max-width: 500px) {
            .order-card-small {
                max-width: 60%; 
                min-width: 150px; 
            }
        }


        .order-card-small:hover {
            box-shadow: 0px 0px 10px 4px rgba(73, 129, 147, 0.2);
        }
        
        .order-card-small .card-name {
            font-size: 16px; 
            line-height: 1.2;
            margin-bottom: 2px;
        }
        
        .order-card-small .card-descr {
            font-size: 12px; 
            -webkit-line-clamp: 1; 
            opacity: 0.8;
            margin-bottom: 4px; 
        }

        .order-card-small .card-details {
            margin-top: 5px;
        }
        
        .order-card-small .card-weight {
            font-size: 14px; 
        }

        .order-card-small .card-price {
            font-size: 20px; 
            font-weight: 700;
        }
    

        .price-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-grey-light);
        }

        .price-row.total {
            font-weight: 700;
            font-size: 18px;
            color: var(--color-purple);
            border-bottom: none;
            padding-top: 15px;
            border-top: 2px solid var(--color-purple-light);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 10px;
            margin-top: 3px;
            width: 16px;
            height: 16px;
        }

        .checkbox-text {
            flex: 1;
        }

        .confirm-button {
            width: 100%;
            padding: 16px;
            background: var(--color-purple);
            color: var(--color-white);
            border: none;
            border-radius: var(--button-border);
            font-family: "Montserrat", sans-serif;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .confirm-button:hover {
            background: var(--color-purple-light);
        }

        .confirm-button:disabled {
            background: var(--color-grey-light);
            cursor: not-allowed;
        }

        .order-message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--button-border);
            font-size: 14px;
        }

        .order-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .order-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .order-message.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .saved-addresses {
            margin-bottom: 20px;
        }

        .saved-address-item {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--color-grey-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .saved-address-item:hover {
            border-color: var(--color-purple);
            background: #f9f5ff;
        }

        .saved-address-item.selected {
            border-color: var(--color-purple);
            background: #f3e5f5;
        }

        .saved-address-text {
            font-size: 14px;
            color: var(--color-black);
        }

        .saved-address-use {
            display: inline-block;
            margin-top: 5px;
            font-size: 12px;
            color: var(--color-blue);
            text-decoration: underline;
            cursor: pointer;
        }

        /* Мобильная адаптация */
        @media (max-width: 991px) {
            .order-grid {
                gap: 20px;
            }

            .form-group {
                padding: 20px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .form-row > div {
                min-width: 100%;
            }

            .order-summary {
                position: static;
            }
        }

        @media (max-width: 767px) {
            .order-card-small {
                max-width: 100%; 
            }
        }
    </style>

<script>
    const isFrontend = window.location.pathname.includes('/frontend/');
    const API_BASE = isFrontend ? '../backend/api/' : 'backend/api/';
    
    const API_AUTH_URL = API_BASE + 'auth.php'; 
    const API_CART_URL = API_BASE + 'cart.php';
    const API_ORDER_URL = API_BASE + 'order.php';

    document.addEventListener('DOMContentLoaded', () => {
        loadUserProfile();
        loadCartItems();   
        setupFormValidation();
    });

    async function loadUserProfile() {
        const userDataStr = localStorage.getItem('user_data');
        if (!userDataStr) {
            showMessage('Будь ласка, увійдіть в акаунт', 'error');
            setTimeout(() => window.location.href = 'index.html', 1500);
            return;
        }

        const localData = JSON.parse(userDataStr);
        const email = localData.email;

        try {
            const response = await fetch(API_AUTH_URL + '?action=getProfile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            const data = await response.json();

            if (data.success && data.user) {
                const u = data.user;
                
                document.getElementById('email').value = u.email || '';
                document.getElementById('fname').value = u.name || u.firstName || '';
                document.getElementById('lname').value = u.lastName || '';
                document.getElementById('phnumber').value = u.phone || '';

                if (u.address) {
                    fillAddressFields(u.address);
                    renderSavedAddresses([u.address]); 
                }
            } else {
                console.warn('Не вдалося отримати дані профілю');
            }
        } catch (error) {
            console.error('Помилка завантаження профілю:', error);
        }
    }

    function fillAddressFields(addr) {
        if (!addr) return;
        document.getElementById('city').value = addr.city || '';
        document.getElementById('street').value = addr.street || '';
        document.getElementById('house').value = addr.house || '';
        document.getElementById('apartment').value = addr.apartment || '';
        document.getElementById('floor').value = addr.floor || '';
    }

    function renderSavedAddresses(addresses) {
        const container = document.getElementById('saved-addresses');
        if (!addresses || addresses.length === 0) return;

        container.innerHTML = '<h4>Ваша збережена адреса:</h4>';
        
        addresses.forEach(addr => {
            const addressText = `${addr.city}, ${addr.street}, ${addr.house}`;
            const div = document.createElement('div');
            div.className = 'saved-address-item';
            div.innerHTML = `
                <div class="saved-address-text">${addressText}</div>
                <span class="saved-address-use" style="color:var(--color-purple); font-size:12px; cursor:pointer; text-decoration:underline;">
                    Заповнити поля цією адресою
                </span>
            `;
            div.onclick = () => fillAddressFields(addr);
            container.appendChild(div);
        });
    }

    function loadCartItems() {
        const userDataStr = localStorage.getItem('user_data');
        if (!userDataStr) return;
        const userEmail = JSON.parse(userDataStr).email;
        
        fetch(API_CART_URL + '?action=get', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (data.items && data.items.length > 0) {
                    renderCartItems(data.items);
                    updateSummary(data.total || 0, data.items.length);
                } else {
                    document.getElementById('cartItemsContainer').innerHTML = 
                        '<p style="text-align: center;">Кошик порожній</p>';
                    updateSummary(0, 0);
                }
            }
        })
        .catch(err => console.error('Error loading cart:', err));
    }

    function renderCartItems(items) {
        const container = document.getElementById('cartItemsContainer');
        container.innerHTML = '';

        items.forEach(item => {
            const imgUrl = item.image_url || './image/placeholder.png'; 
            const itemTotal = (item.price * item.quantity).toFixed(2);
            
            const html = `
            <div class="card-container order-card-small">
                <img class="card-img" src="${imgUrl}" onerror="this.src='./image/placeholder.png'">
                <div class="card">
                    <div class="card-text">
                        <p class="card-name">${item.name}</p>
                        <p class="card-descr">${item.quantity} шт. х ${item.price} грн</p>
                    </div>
                    <div class="card-details">
                        <p class="card-weight">${item.weight || 1} кг</p>
                        <p class="card-price">${itemTotal} грн</p>
                    </div>
                </div>
            </div>`;
            container.innerHTML += html;
        });
    }

    function updateSummary(subtotal, count) {
        const deliveryCost = (count > 0) ? 0 : 0; 
        
        document.getElementById('subtotal').textContent = parseFloat(subtotal).toFixed(2) + ' грн';
        document.getElementById('delivery-price').textContent = deliveryCost.toFixed(2) + ' грн';
        document.getElementById('total-price').textContent = (parseFloat(subtotal) + deliveryCost).toFixed(2) + ' грн';
    }

    async function submitOrder() {
        if (!validateForm()) return;

        const userDataStr = localStorage.getItem('user_data');
        const userEmail = JSON.parse(userDataStr).email;

        const orderData = {
            email: userEmail, 
            userData: {
                first_name: document.getElementById('fname').value,
                last_name: document.getElementById('lname').value,
                phone: document.getElementById('phnumber').value
            },
            deliveryAddress: {
                city: document.getElementById('city').value,
                street: document.getElementById('street').value,
                house: document.getElementById('house').value,
                apartment: document.getElementById('apartment').value,
                floor: document.getElementById('floor').value
            },
            paymentMethod: document.querySelector('input[name="payment"]:checked').value,
            comment: document.getElementById('comment').value
        };

        const btn = document.querySelector('.confirm-button');
        btn.disabled = true;
        btn.textContent = 'Обробка...';

        try {
            const response = await fetch(API_ORDER_URL + '?action=create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            const text = await response.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error("Server Response:", text);
                throw new Error("Сервер повернув помилку. Перевірте консоль.");
            }

            if (data.success) {
                showMessage(`✅ Замовлення №${data.order_id} успішно створено!`, 'success');
                setTimeout(() => {
                    window.location.href = 'account.html';
                }, 2000);
            } else {
                showMessage(data.message || 'Помилка створення замовлення', 'error');
                btn.disabled = false;
                btn.textContent = 'Підтвердити замовлення';
            }

        } catch (error) {
            console.error(error);
            showMessage('Сталася помилка з\'єднання', 'error');
            btn.disabled = false;
            btn.textContent = 'Підтвердити замовлення';
        }
    }

    function validateForm() {
        const requiredIds = ['fname', 'lname', 'phnumber', 'email', 'city', 'street', 'house'];
        let isValid = true;
        
        requiredIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                el.style.borderColor = 'red';
                isValid = false;
            } else {
                el.style.borderColor = '#D9D9D9';
            }
        });

        if (!document.getElementById('consent').checked) {
            alert('Будь ласка, надайте згоду на обробку даних');
            isValid = false;
        }

        if (!isValid) showMessage('Заповніть обов\'язкові поля', 'error');
        return isValid;
    }

    function showMessage(msg, type) {
        const box = document.getElementById('orderMessage');
        box.textContent = msg;
        box.className = 'order-message ' + type;
        box.style.display = 'block';
    }

    function setupFormValidation() {
        const inputs = document.querySelectorAll('.account-input');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if(this.value.trim() !== '') this.style.borderColor = '#D9D9D9';
            });
        });
    }
    
    function myFunction() {
        var x = document.getElementById("nav");
        if (x.className === "topnav") {
            x.className += " responsive";
        } else {
            x.className = "topnav";
        }
    }
</script>
</body>

</html>