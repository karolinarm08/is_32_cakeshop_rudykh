<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Редагування товару</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Стилі для форми */
        .add-product-form {
            display: flex; flex-direction: column; gap: 20px; max-width: 800px;
            margin: 20px auto; padding: 20px; border: 1px solid var(--color-grey-light);
            border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .form-row { display: flex; gap: 20px; }
        .form-row.full-width > .form-group { flex-basis: 100%; }
        .form-group { display: flex; flex-direction: column; flex: 1; }
        .form-group label { font-weight: 600; margin-bottom: 5px; color: #7F4B93; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 1px solid #747474;
            border-radius: 10px; font-size: 16px; box-sizing: border-box;
        }
        .btn-submit { background-color: #7F4B93; color: white; border: none; cursor: pointer; padding: 12px 20px; border-radius: 10px; font-weight: bold; }
        .btn-submit:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Галерея */
        .thumbnail-row { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }
        .thumbnail-wrapper { position: relative; width: 100px; height: 100px; flex-shrink: 0; }
        .thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; border: 2px solid #ddd; }
        
        /* Кнопка видалення (хрестик) */
        .btn-delete-img {
            position: absolute; top: -5px; right: -5px;
            background: red; color: white; width: 24px; height: 24px;
            border-radius: 50%; text-align: center; line-height: 22px;
            cursor: pointer; font-weight: bold; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .btn-delete-img:hover { transform: scale(1.1); }

        #selectedImage { width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="main">
        <h2 class="title" style="text-align: center; margin-top: 20px;" id="formTitle">Додавання товару</h2>

        <form id="productForm" class="add-product-form" onsubmit="handleProductSubmit(event)">
            <input type="hidden" id="productId" name="product_id" value=""> 
            
            <!-- Основне фото -->
            <div style="text-align: center;">
                <img id="selectedImage" src="https://placehold.co/600x400/eee/999?text=No+Image" alt="Preview">
            </div>

            <!-- Галерея -->
            <div>
                <label>Галерея (Ви можете видаляти старі фото):</label>
                <div class="thumbnail-row" id="thumbnailRow"></div>
            </div>
            
            <div class="form-row full-width">
                 <div class="form-group">
                    <label>Назва товару*</label>
                    <input type="text" id="productName" name="name" required>
                </div>
            </div>

            <div class="form-row full-width">
                <div class="form-group">
                    <label>Опис</label>
                    <textarea id="productDescription" name="description"></textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ціна, грн*</label>
                    <input type="number" id="productPrice" name="price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Вага, кг</label>
                    <input type="number" id="productWeight" name="weight" step="0.01" value="1.0">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Категорія*</label>
                    <select id="productCategory" name="category_id" required>
                        <option value="1">Торти</option>
                        <option value="2">Мусові тістечка</option>
                        <option value="3">Еклери</option>
                        <option value="4">Макарон</option>
                        <option value="5">Тарти</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Активний</label>
                    <select id="productIsActive" name="is_active">
                        <option value="1">Так</option>
                        <option value="0">Ні</option>
                    </select>
                </div>
            </div>
            
            <!-- Завантаження нових фото -->
            <div class="form-group">
                <label style="color: #2e7d32;">Додати НОВІ фото (з'являться після збереження):</label>
                <input type="file" id="productImageUpload" name="images[]" accept="image/*" multiple>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="button" onclick="history.back()" style="padding: 10px 20px; cursor: pointer;">Назад</button>
                <button type="submit" class="btn-submit" id="submitBtn">ЗБЕРЕГТИ</button>
            </div>
        </form>
    </div>

<script>
    const defaultImageSrc = "https://placehold.co/600x400/eee/999?text=No+Image";
    const thumbnailRow = document.getElementById('thumbnailRow');
    const selectedImage = document.getElementById('selectedImage');

    // Перевірка на режим редагування при завантаженні
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) {
            enableEditMode(editId);
        }
    });

    // Заповнення форми даними
    async function enableEditMode(id) {
        document.getElementById('formTitle').textContent = 'Редагування товару #' + id;
        document.getElementById('productId').value = id;
        document.getElementById('submitBtn').textContent = 'ОНОВИТИ ТОВАР';

        // URL залежить від того, де ми знаходимось (frontend папка чи корінь)
        let apiPath = window.location.pathname.includes('/frontend/') 
            ? '../backend/product_api.php?action=get&id=' + id 
            : '/backend/product_api.php?action=get&id=' + id;

        try {
            const response = await fetch(apiPath);
            const data = await response.json();
            
            if (data.success && data.product) {
                const p = data.product;
                document.getElementById('productName').value = p.name;
                document.getElementById('productDescription').value = p.description;
                document.getElementById('productPrice').value = p.price;
                document.getElementById('productWeight').value = p.weight;
                document.getElementById('productCategory').value = p.category_id;
                document.getElementById('productIsActive').value = p.is_active;

                renderExistingImages(p.images_array);
                if (p.main_image) selectedImage.src = p.main_image;
            }
        } catch (e) {
            console.error(e);
            alert("Помилка завантаження даних товару");
        }
    }

    // Відображення існуючих фото з кнопками видалення
    // --- ОНОВЛЕНА ФУНКЦІЯ: Відображення існуючих фото з кнопками видалення ---
    function renderExistingImages(images) {
        thumbnailRow.innerHTML = '';
        if (!images || images.length === 0) return;

        images.forEach(imgUrl => {
            const wrapper = document.createElement('div');
            wrapper.className = 'thumbnail-wrapper';

            const img = document.createElement('img');
            img.src = imgUrl;
            img.className = 'thumbnail';
            img.onclick = () => selectedImage.src = imgUrl;

            const delBtn = document.createElement('div');
            delBtn.className = 'btn-delete-img';
            delBtn.innerHTML = '&times;';
            delBtn.title = 'Видалити назавжди';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                deleteImageFromServer(imgUrl, wrapper);
            };

            wrapper.appendChild(img);
            wrapper.appendChild(delBtn);
            thumbnailRow.appendChild(wrapper);
        });
    }

    async function deleteImageFromServer(imgUrl, element) {
        if (!confirm('Видалити це фото?')) return;

        let apiPath = window.location.pathname.includes('/frontend/') 
            ? '../backend/product_api.php?action=delete_image' 
            : '/backend/product_api.php?action=delete_image';

        try {
            const response = await fetch(apiPath, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_url: imgUrl })
            });
            const res = await response.json();

            if (res.success) {
                element.remove(); // Видаляємо з екрану
                if (selectedImage.src.includes(imgUrl)) selectedImage.src = defaultImageSrc;
            } else {
                alert("Помилка: " + res.message);
            }
        } catch (e) {
            alert("Помилка з'єднання");
        }
    }

    // Попередній перегляд НОВИХ файлів (зелена рамка)
    document.getElementById('productImageUpload').addEventListener('change', function(e) {
        const files = e.target.files;
        // Не очищаємо thumbnailRow, просто додаємо прев'ю в кінець
        // Або можна очистити тільки "нові" прев'ю, якщо треба
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            reader.onload = function(evt) {
                const wrapper = document.createElement('div');
                wrapper.className = 'thumbnail-wrapper';
                
                const img = document.createElement('img');
                img.src = evt.target.result;
                img.className = 'thumbnail';
                img.style.borderColor = '#2e7d32'; // Зелена рамка для нових
                img.style.borderWidth = '3px';
                
                wrapper.appendChild(img);
                thumbnailRow.appendChild(wrapper);
                
                if (selectedImage.src === defaultImageSrc) selectedImage.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    // Відправка форми
    async function handleProductSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const id = document.getElementById('productId').value;
        const action = id ? 'update' : 'create';

        let apiPath = window.location.pathname.includes('/frontend/') 
            ? '../backend/product_api.php?action=' + action 
            : '/backend/product_api.php?action=' + action;

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'ЗБЕРЕЖЕННЯ...';

        try {
            const response = await fetch(apiPath, { method: 'POST', body: formData });
            
            // Читаємо відповідь як текст спочатку, щоб зловити PHP помилки
            const text = await response.text();
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error("Server Error:", text);
                alert("Сервер повернув помилку (див. консоль)");
                btn.disabled = false;
                return;
            }

            if (data.success) {
                alert(data.message);
                if (action === 'create') {
                    form.reset();
                    thumbnailRow.innerHTML = '';
                    selectedImage.src = defaultImageSrc;
                } else {
                    location.reload(); // Перезавантажити, щоб побачити оновлені дані
                }
            } else {
                alert("Помилка: " + data.message);
            }
        } catch (error) {
            console.error(error);
            alert("Помилка мережі");
        } finally {
            btn.disabled = false;
            btn.textContent = id ? 'ОНОВИТИ ТОВАР' : 'ЗБЕРЕГТИ';
        }
    }
</script>
</body>
</html>