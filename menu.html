<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" type="image/x-icon" href="./image/favicon.ico">
    <title>Меню</title>        
</head>
<body>
<header>
    <nav id="nav" class="topnav">
        <div class="nav-logo"><a href="./index.html">RUBY</a></div>
        <a href="javascript:void(0);" class="icon" onclick="myFunction()"><i class="fa fa-bars"></i></a>
        <div class="nav-main">
            <div class="nav-first">
                <a href="./menu.html" class="active">Меню</a>
                <a href="./index.html#about-us">Про нас</a>
                <a href="./news.html">Новини</a>
                <a href="./info.html">Інформація</a>
                <a href="./contacts.html">Контакти</a>
            </div>
            <div class="nav-second">
                <a href="./account.html"><i class="fa fa-user" aria-hidden="true"></i></a>
                <a href="./shoppingcart.html"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
            </div>
        </div>   
    </nav>
</header>

<main>
    <div id="scrollToTopBtn"></div>
    <script src="code.js"></script>       
    <div class="banner">
        <img src="./image/waves_4.png" width="100%" alt="волны">
    </div>
    <div class="main">
        <h2 class="title">Меню</h2>
        <div class="menu filters">
             <div class="main-filters">            
                <button class="filter"><i class="fa fa-filter"></i></button>
                <button class="filter-button">НОВИНКИ</button>        
                <button class="filter-button">ТОРТИ</button>
            </div>
            <form class="search-form">
                <input class="search-input" type="text" placeholder="Пошук...">
                <button class="search-button" type="submit"><img src="./image/search.svg" alt=""></button>
            </form>
        </div>
        
        <div class="menu-cards-container" id="productsContainer">
            <a href="./product_change.html" class="add-container" id="addProductBtn" style="display: none;">
                <img src="./image/Group 76.jpg" alt="" class="add-button">
            </a>
            
            <div id="loadingMessage" style="text-align: center; grid-column: span 3; font-size: 1.2em; color: var(--color-purple);">
                Завантаження товарів...
            </div>
        </div>
        <div class="cont">
            <button class="cont-button"><img src="./image/Line 1.png"></button>    
        </div>
    </div>
</main>
<div id="footer"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        checkAdminRights(); 
        fetchProducts();    
    });

    function checkAdminRights() {
        const userDataStr = localStorage.getItem('user_data');
        if (userDataStr) {
            const user = JSON.parse(userDataStr);
            console.log("User role:", user.role); 
            
            if (user.role === 'admin') {
                const btn = document.getElementById('addProductBtn');
                if (btn) btn.style.display = 'flex';
                
                const navFirst = document.querySelector('.nav-first');
                if (navFirst) {
                    const adminLink = document.createElement('a');
                    adminLink.href = 'admin_orders.html';
                    adminLink.style.color = 'red';
                    adminLink.style.fontWeight = 'bold';
                    adminLink.textContent = 'Адмін Панель';
                    navFirst.appendChild(adminLink);
                }
            }
        }
    }

    function createProductCard(product) {
        const cardHtml = `
            <a href="./product.html?id=${product.id}" class="card-container">
                <img class="card-img" src="./${product.main_image}" 
                     onerror="this.onerror=null;this.src='./image/placeholder.png';" 
                     alt="${product.name}">
                <div class="card">
                    <div class="card-text">
                        <p class="card-name">${product.name}</p>
                        <p class="card-descr">${product.description}</p>
                    </div>
                    <div class="card-details">
                        <p class="card-weight">${product.weight} кг</p>
                        <p class="card-price">${product.price} грн</p>
                    </div>
                </div>
            </a>
        `;
        const div = document.createElement('div');
        div.innerHTML = cardHtml.trim();
        return div.firstChild;
    }

    async function fetchProducts() {
        const container = document.getElementById('productsContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        let apiPath = '/backend/product_api.php?action=list';
        if (window.location.pathname.includes('/frontend/')) { apiPath = '../backend/product_api.php?action=list'; }

        try {
            const response = await fetch(apiPath);
            const data = await response.json();

            loadingMessage.style.display = 'none';

            if (data.success && data.products && data.products.length > 0) {
                data.products.forEach(product => {
                    const card = createProductCard(product);
                    container.appendChild(card);
                });
            } else {
                const noProducts = document.createElement('p');
                noProducts.style.textAlign = 'center';
                noProducts.style.gridColumn = 'span 3';
                noProducts.textContent = data.message || 'Наразі товарів у меню немає.';
                container.appendChild(noProducts);
            }
        } catch (error) {
            loadingMessage.textContent = 'Помилка завантаження меню.';
            console.error("Error:", error);
        }
    }
</script>
</body>
</html>