<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUBY API Test Runner</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Montserrat", sans-serif; background: #f4f4f9; padding: 20px; max-width: 900px; margin: 0 auto; }
        h1 { color: #7F4B93; text-align: center; }
        .controls { text-align: center; margin-bottom: 20px; }
        button { background: #7F4B93; color: white; border: none; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 5px; font-family: inherit; font-weight: bold; }
        button:hover { background: #6a3e7a; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .test-suite { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .test-suite h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; }
        
        .test-case { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .test-case:last-child { border-bottom: none; }
        .test-name { font-weight: 500; }
        .test-status { font-weight: bold; font-size: 14px; min-width: 80px; text-align: right; }
        
        .status-pending { color: #999; }
        .status-running { color: #e67e22; }
        .status-pass { color: #2ecc71; }
        .status-fail { color: #e74c3c; }
        
        .console-log { background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto; margin-top: 20px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .log-success { color: #2ecc71; }
        .log-error { color: #ff7675; }
        
        .progress-bar { height: 5px; background: #ddd; margin-top: 20px; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #7F4B93; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

    <h1>üîç RUBY System Tests</h1>
    
    <div class="controls">
        <button onclick="runAllTests()" id="runBtn">–ó–ê–ü–£–°–¢–ò–¢–ò –í–°–Ü –¢–ï–°–¢–ò</button>
    </div>

    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>

    <!-- AUTH TESTS -->
    <div class="test-suite">
        <h2>1. –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è (Auth API)</h2>
        <div class="test-case" id="test-register">
            <span class="test-name">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
        <div class="test-case" id="test-login">
            <span class="test-name">–í—Ö—ñ–¥ —ñ—Å–Ω—É—é—á–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
        <div class="test-case" id="test-login-fail">
            <span class="test-name">–í—Ö—ñ–¥ –∑ –Ω–µ–≤—ñ—Ä–Ω–∏–º –ø–∞—Ä–æ–ª–µ–º (–ú–∞—î –±—É—Ç–∏ –ø–æ–º–∏–ª–∫–∞)</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
    </div>

    <!-- PRODUCT TESTS -->
    <div class="test-suite">
        <h2>2. –¢–æ–≤–∞—Ä–∏ (Product API)</h2>
        <div class="test-case" id="test-products-list">
            <span class="test-name">–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä—ñ–≤</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
        <div class="test-case" id="test-product-detail">
            <span class="test-name">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä—É (ID=1)</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
    </div>

    <!-- CART & ORDER TESTS -->
    <div class="test-suite">
        <h2>3. –ö–æ—à–∏–∫ —Ç–∞ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
        <div class="test-case" id="test-cart-add">
            <span class="test-name">–î–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É –≤ –∫–æ—à–∏–∫</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
        <div class="test-case" id="test-cart-get">
            <span class="test-name">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–º—ñ—Å—Ç—É –∫–æ—à–∏–∫–∞</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
        <div class="test-case" id="test-order-create">
            <span class="test-name">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</span>
            <span class="test-status status-pending">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</span>
        </div>
    </div>

    <div class="console-log" id="consoleLog">
        <div>System ready. Press "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–µ—Å—Ç–∏" to start...</div>
    </div>

    <script>
        // –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
        // –ó–º—ñ–Ω—é—î–º–æ –±–∞–∑–æ–≤–∏–π URL –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, –¥–µ —Ñ–∞–π–ª –≤—ñ–¥–∫—Ä–∏—Ç–æ
        // –Ø–∫—â–æ —Ñ–∞–π–ª –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –ø—Ä–æ—Å—Ç–æ —è–∫ —Ñ–∞–π–ª, API –Ω–µ —Å–ø—Ä–∞—Ü—é—î (–ø–æ—Ç—Ä—ñ–±–µ–Ω —Å–µ—Ä–≤–µ—Ä)
        const API_BASE = '../backend/api/'; // –í—ñ–¥–Ω–æ—Å–Ω–∏–π —à–ª—è—Ö –¥–ª—è XAMPP
        const testEmail = `test_auto_${Date.now()}@example.com`; // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π email –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É
        const testPass = 'password123';
        let testUserId = null;

        function log(msg, type = 'info') {
            const consoleDiv = document.getElementById('consoleLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : ''));
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function setStatus(id, status, text) {
            const el = document.querySelector(`#${id} .test-status`);
            el.className = `test-status status-${status}`;
            el.textContent = text || status.toUpperCase();
            if(status === 'fail') log(`TEST FAILED: ${id}`, 'error');
        }

        async function runAllTests() {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            document.getElementById('progressBar').style.width = '0%';
            
            log("--- STARTING TEST SUITE ---");
            
            try {
                // 1. REGISTER
                await runTest('test-register', async () => {
                    const res = await fetch(API_BASE + 'auth.php?action=register', {
                        method: 'POST', body: JSON.stringify({ email: testEmail, password: testPass, name: 'AutoTester' })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    return "OK";
                });
                updateProgress(15);

                // 2. LOGIN
                await runTest('test-login', async () => {
                    const res = await fetch(API_BASE + 'auth.php?action=login', {
                        method: 'POST', body: JSON.stringify({ email: testEmail, password: testPass })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    testUserId = data.user.id; // Save ID for later
                    return "OK";
                });
                updateProgress(30);

                // 3. LOGIN FAIL
                await runTest('test-login-fail', async () => {
                    const res = await fetch(API_BASE + 'auth.php?action=login', {
                        method: 'POST', body: JSON.stringify({ email: testEmail, password: 'wrong_password' })
                    });
                    const data = await res.json();
                    // –¢—É—Ç –º–∏ –æ—á—ñ–∫—É—î–º–æ success: false. –Ø–∫—â–æ true - —Ü–µ –ø–æ–º–∏–ª–∫–∞ —Ç–µ—Å—Ç—É
                    if (data.success) throw new Error("–í—Ö—ñ–¥ –≤–¥–∞–≤—Å—è –∑ –Ω–µ–≤—ñ—Ä–Ω–∏–º –ø–∞—Ä–æ–ª–µ–º!");
                    return "OK (–í—ñ–¥–º–æ–≤–ª–µ–Ω–æ)";
                });
                updateProgress(45);

                // 4. PRODUCTS LIST
                await runTest('test-products-list', async () => {
                    const res = await fetch('../backend/product_api.php?action=list');
                    const data = await res.json();
                    if (!data.success || !Array.isArray(data.products)) throw new Error("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ");
                    if (data.products.length === 0) log("Warning: Products list is empty", 'error');
                    return `OK (${data.products.length} items)`;
                });
                updateProgress(60);

                // 5. CART ADD
                await runTest('test-cart-add', async () => {
                    const res = await fetch(API_BASE + 'cart.php?action=add', {
                        method: 'POST', body: JSON.stringify({ email: testEmail, product_id: 1, quantity: 2 })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    return "OK";
                });
                updateProgress(75);

                // 6. CART GET
                await runTest('test-cart-get', async () => {
                    const res = await fetch(API_BASE + 'cart.php?action=get', {
                        method: 'POST', body: JSON.stringify({ email: testEmail })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î —Ç–∞–º —Ç–æ–≤–∞—Ä
                    const hasItem = data.items.some(i => i.product_id == 1 && i.quantity == 2);
                    if (!hasItem) throw new Error("–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ—à–∏–∫—É");
                    return "OK";
                });
                updateProgress(90);

                // 7. ORDER CREATE
                await runTest('test-order-create', async () => {
                    const orderData = {
                        email: testEmail,
                        deliveryAddress: { city: 'Test City', street: 'Test St', house: '1' },
                        paymentMethod: 'cash'
                    };
                    const res = await fetch(API_BASE + 'order.php?action=create', {
                        method: 'POST', body: JSON.stringify(orderData)
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.message);
                    return `OK (Order #${data.order_id})`;
                });
                updateProgress(100);

                log("--- ALL TESTS COMPLETED SUCCESSFULLY ---", 'success');

            } catch (e) {
                log("--- TESTING STOPPED DUE TO CRITICAL ERROR ---", 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function runTest(elementId, testFn) {
            setStatus(elementId, 'running', '...');
            try {
                const resultMsg = await testFn();
                setStatus(elementId, 'pass', resultMsg);
                log(`${elementId}: Passed`, 'success');
            } catch (error) {
                setStatus(elementId, 'fail', 'FAIL');
                log(`${elementId} FAILED: ${error.message}`, 'error');
                throw error; // Stop chain
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }
    </script>
</body>
</html>